@model BKI_CRM2.Models.MailModel
@{
    ViewBag.Title = "Index";
    var listSelectListItems = ViewBag.listSelectListItems;
}

<div class="title">
    <h2>GỬI EMAIL</h2>
</div>
@using (@Ajax.BeginForm("Index2", "SendMailer", new AjaxOptions { HttpMethod = "POST", UpdateTargetId = "body" }, new { @id = "form1" }))
{
    @Html.AntiForgeryToken()
    <font color="red">@Html.ValidationSummary()</font>
    <table class="table">
        <tbody>
            <tr>
                <td>To:</td>
                @*<td>@Html.TextBoxFor(m => m.To, new { @class = "form-control" })</td>*@
                 <td>
                    @* @Html.ListBox(, ViewBag.Skills as MultiSelectList,new { @class = "chzn-select", data_placeholder = "Choose a Country..." } )*@
                     @Html.ListBoxFor(model => model.SelectedContact, Model.To, new { @class = "chzn-select", Multiple = "multiple", id="khachhang" })
                 </td>
             </tr>
            <tr>
                <td>Subject:</td>
                <td>@Html.TextBoxFor(m => m.Subject, new { @class = "form-control" })</td>
            </tr>
            <tr>
                <td>Attachment</td>
                <td><input name="fileUploader" type="file" id="attachment" onchange="upfile();" /><span id="status"></span></td>
            </tr>
            <tr>
                <td>Body:</td>
                <td>@Html.TextAreaFor(m => m.Body, new { @class = "form-control", @style="height:150px"})</td>
            </tr>
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary" id="guiemail"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>&nbsp Gửi</button>
}
<script>
    $(document).ready(function () {
        if ('@ViewBag.Message' == 'Sent') {
            alert('Gửi mail thành công!');
        }
        else if ('@ViewBag.Message' == 'Not Sent') {
            alert('Có lỗi!');
        }
        else if ('@ViewBag.Message' == 'No address') {
            alert('Không có địa chỉ email nào được chọn!');
        }
        
        $('select').select2();

        $('#guiemail').click(function () {
            var khachhang = $('#khachhang').text();
            var values = khachhang.join(',');
            $.ajax({
                url: "/SendMailer/Index2",
                type: "POST",
                data: {
                    values: values,
                },
                error: function () {
                    alert("Có lỗi");
                },
                success: function (data) {
                    alert("Thành công!");

                    $('#body').html(data);

                }
            });
        })
    });
    function upfile() {
        var data = new FormData();
        var files = $("#attachment").get(0).files;
        if (files.length > 0) {
            data.append("Attachments", files[0])
        }
        $.ajax({
            url: "/SendMailer/GetFileRequest",
            type: "POST",
            processData: false,
            contentType: false,
            data: data,
            success: function () {
                $('#status').css('color', 'green');
                $('#status').html('OK');
            },
            error: function () {
                $('#status').css('color', 'red');
                $('#status').html('Không upload được file!');
            }

        });
    }
</script>


